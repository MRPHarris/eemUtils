---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# eemUtils

<!-- badges: start -->

<!-- badges: end -->

The **eemUtils** package serves as a repository for various functions to manipulate, analyse, and plot fluorescence data. It utilises the existing R fluorescence analysis framework provided by the [eemR](https://cran.r-project.org/web/packages/eemR/index.html), [staRdom](https://github.com/MatthiasPucher/staRdom) and [EEM](https://CRAN.R-project.org/package=EEM) packages. Many of the functions within this package are alterations to existing functions within from eemR, staRdom or EEM - thus, if you use the functions from this package, please allocate proper credit to those packages and their authors. Most eemUtils functions deal with fluorescence data, though some are general utility functions which, whilst a part of the fluorescence functions, can be used more generally.

This package is a work in progress - many of the functions were developed for a dataset currently in preparation for publication, and so I cannot currently upload data or detailed examples in most cases. The goal is to eventually upload that dataset and the accompanying workflow as an offshoot to this package.

If you have any questions or comments, please don't hesitate to get in touch.

## Example functions

Below are just a few of the 20+ functions contained within this package.

#### plot_eem_3D

A simple conversion of `staRdom::eempf_comps3D()`, but for use with sample EEM data, rather than outputs from a PARAFAC model.

```
plot_eem_3D()
```
<p align="center">
  <img src="man/figures/3D_eem_example.png" height="400px" />
</p>

#### Generate_CORCONDIA

`Generate_CORCONDIA()` is a simple function wrapper for staRdom's existing core consistency diagnostic function `staRdom::eempf_corcondia()`. It produces a more legible output. 

<p align="center">
  <img src="man/figures/generate_CORCONDIA_example.PNG" height="400px" />
</p>

#### extrpf_loadings

Use `extrpf_loadings()` to get the modeled per-sample fluorescence intensity loadings for each component within a set of PARAFAC models. This is a simple way to get quick series data from any number of PARAFAC models generated by `staRdom::eem_parafac()`

#### extract_ramanpeak_areas

This function incorporates two methods in order to find the area under the Raman peak of water, for EEM data Raman Unit normalisation purposes. The first method utilises a port of the MATLAB package drEEM's RamanIntegrationRange function, which uses adjustable gradient detection to identify the start and end of the Raman peak. The second method is a straightforward, fixed-range integration used by the Aqualog fluorometer, which assumes the Raman peak extends from 380nm to 410nm at 350nm excitation.

Some sample Raman curve spectra are included in this package as below.

```{r, echo = TRUE, eval = TRUE, collapse = TRUE}
library(pacman)
pacman::p_load(eemUtils,ggplot2,cowplot,pracma,magrittr,magick)
data(SampleRamanCurves)
head(SampleRamanCurves)
```

`extract_ramanpeak_areas()` can then be used to get the areas under the raman peaks, and exported as image and/or .gif files for visualisation. The below .gif shows a use of the drEEM RamanIntegrationRange method, using gradient detection. 

```{r, echo = TRUE, eval = TRUE, collapse = TRUE}
eemUtils::extract_ramanpeak_areas(RAMdat = SampleRamanCurves, range_upper = 500, method = "RIR", output_dir = NULL, gif = FALSE)
```

This function can also optionally produce images or a .gif of the detected peak bounds and areas.

<p align="center">
  <img src="man/figures/Peaks_RIR.gif" height="500px" />
</p>


## Installation

To get access to the functions in **eemUtils**, simply use the **devtools** package to install the package from github.

```r
devtools::install_github("MRPHarris/eemUtils")
```

## References

Massicotte, P. (2019). eemR: Tools for Pre-Processing Emission-Excitation-Matrix (EEM) Fluorescence Data. R
  package version 1.0.1. https://CRAN.R-project.org/package=eemR

Murphy, K. R., Stedmon, C. A., Graeber, D., & Bro, R. (2013). Fluorescence spectroscopy and multi-way techniques. PARAFAC. _Analytical Methods_, *5*, 6557–6566. doi: [10.1039/C3AY41160E](https://doi.org/10.1039/C3AY41160E)

Pucher, M., Wünsch, U., Weigelhofer, G., Murphy, K., Hein, T., & Graeber, D. (2019). staRdom: Versatile Software for Analyzing Spectroscopic Data of Dissolved Organic Matter in R. _Water_, *11*, 2366. doi: [10.3390/w11112366](https://doi.org/10.3390/w11112366)

Trivittayasil, V. (2016). EEM: Read and Preprocess Fluorescence Excitation-Emission Matrix (EEM) Data. R package
  version 1.1.1. https://CRAN.R-project.org/package=EEM
